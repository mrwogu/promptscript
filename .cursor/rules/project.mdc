---
description: "Project-specific rules"
alwaysApply: true
---

You are working on PromptScript at PromptScript.

Tech stack: typescript, Node.js 20+, Nx, pnpm workspaces

## Architecture

  The project is organized as a monorepo with these packages:

  ```mermaid
  flowchart TB
    subgraph packages
      core[core - Types, errors, utilities]
      parser[parser - Chevrotain-based parser]
      resolver[resolver - Inheritance & import resolution]
      validator[validator - AST validation rules]
      compiler[compiler - Pipeline orchestration]
      formatters[formatters - Output formatters]
      cli[cli - Command-line interface]
    end

    cli --> compiler
    cli --> resolver
    compiler --> resolver
    compiler --> validator
    compiler --> formatters
    resolver --> parser
    parser --> core
    resolver --> core
    validator --> core
    formatters --> core
  ```

  ## Key Libraries

  - Parser: Chevrotain
  - CLI: Commander.js
  - Testing: Vitest
  - Linting: ESLint + Prettier

## Project Structure (Library)
  - src/ - Source code
  - src/index.ts - Public API exports
  - src/types/ - TypeScript type definitions
  - src/__tests__/ - Unit tests
  - dist/ - Compiled output

  ## Project Structure (Monorepo)
  - packages/ - Individual packages
  - packages/*/src/ - Package source
  - packages/*/package.json - Package manifest

Code style:
- useUnknown: with type guards instead of any
- interfaces: for object shapes
- types: for unions and intersections
- exports: named only, no default exports
- returnTypes: explicit on public functions
- target: ES2022 or later
- moduleResolution: NodeNext or Bundler
- declaration: generate .d.ts files
- files: kebab-case.ts
- classes: PascalCase
- interfaces: PascalCase
- functions: camelCase
- variables: camelCase
- constants: UPPER_SNAKE_CASE
- customClasses: extend PSError
- messages: actionable
- filePattern: *.spec.ts next to source
- pattern: AAA (Arrange, Act, Assert)
- coverage: aim for >80%
- fixtures: for parser tests
- framework: vitest
- types: unit tests colocated with source

Git Commits:
- format: Conventional Commits
- reference: https://www.conventionalcommits.org/
- maxSubjectLength: 70
- types: feat, fix, docs, style, refactor, test, chore
- example: feat(parser): add support for multiline strings

Config:
- eslint: inherit from eslint.base.config.cjs
- viteRoot: __dirname (not import.meta.dirname)

Commands:
/review - Review code for quality, type safety, and best practices
/test - Write unit tests using:
/build - Run verification commands:
/newpkg - Generate new package with Nx:
/test-unit - Write unit tests following AAA pattern with proper isolation
/test-integration - Write integration tests for component boundaries
/test-e2e - Write end-to-end tests for critical user journeys
/test-coverage - Analyze test coverage and suggest improvements
/quality - Review code for quality improvements
/refactor - Suggest refactoring opportunities
/security-review - Review code for security vulnerabilities
/threat-model - Analyze potential security threats
/export - Design public API exports
/type - Create TypeScript type definitions
/cli - Create CLI command handler

Development Commands:
```bash
  pnpm install              # Install dependencies
  pnpm nx build <pkg>       # Build package
  pnpm nx test <pkg>        # Run tests
  pnpm nx lint <pkg>        # Lint code
  pnpm nx run-many -t test  # Test all packages
  pnpm nx graph             # View dependency graph
  pnpm prs compile          # Compile .prs files (uses local dev version)
  ```

Post-Work Verification:
After completing code changes, always run:
  ```bash
  pnpm run format     # Format code with Prettier
  pnpm run lint       # Check for linting errors
  pnpm run build      # Build all packages
  pnpm run typecheck  # Verify TypeScript types
  pnpm run test       # Run all tests
  ```

Documentation:
- review README.md and docs/ before changes
- update docs if behavior changes
- keep accurate

Diagrams:
- Use Mermaid (exception: packages/*/README.md must use ASCII art because npm does not render Mermaid)
- Types: flowchart, sequence, class, state, ER, gantt, pie

Never:
- Never use `any` type - use `unknown` with type guards
- Never use default exports - only named exports
- Never commit without tests
- Never skip error handling
- Never leave TODO without issue reference
- Never create packages manually - use Nx generators (nx g @nx/js:lib)
- Never create custom ESLint rules in package configs - extend base config
- Never use `import.meta.dirname` in vite/vitest configs - use `__dirname`
- Never reference line numbers in test names or comments
- Never make code changes without verifying documentation consistency
- Never commit directly to main/master
- Never force push to shared branches
- Never commit secrets or credentials
- Never create commits with unrelated changes
- Never test implementation details
- Never write tests that depend on execution order
- Never share mutable state between tests
- Never ignore flaky tests
- Never sacrifice readability for micro-optimizations
- Never leave dead code or commented-out blocks
- Never use magic numbers without named constants
- Never ignore compiler/linter warnings without justification
- Never generate code with known vulnerabilities
- Never expose secrets, credentials, or API keys
- Never disable security features without explicit user consent
- Never trust user input without validation
- Never use deprecated or insecure cryptographic functions
- Never generate harmful, illegal, or unethical content
- Never pretend to have capabilities you don't have
- Always clarify when unsure rather than guessing
- Never use default exports - named exports only
- Never expose internal implementation details
- Never break semver without major version bump
- Never publish without type declarations
